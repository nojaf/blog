{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022/05/24/word-domination-part-one/",
    "result": {"data":{"site":{"siteMetadata":{"title":"blog.nojaf.com","author":"Florian Verdonck"}},"markdownRemark":{"id":"37e4f76e-75f3-5d78-b8e5-43566998ce31","excerpt":"Intro Some time ago, I was able to merge in a huge refactoring effort into the next major version of Fantomas. The result of these changes make Fantomas at…","html":"<h2>Intro</h2>\n<p>Some time ago, I was able to merge in a <a href=\"https://github.com/fsprojects/fantomas/pull/2218\">huge refactoring effort</a> into <a href=\"https://github.com/fsprojects/fantomas/issues/2160\">the next major version of Fantomas</a>.<br>\nThe result of these changes make Fantomas <strong>at least twice as fast as the v4 release</strong>.</p>\n<p><em>Before</em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">BenchmarkDotNet=v0.13.1, OS=ubuntu 20.04\nIntel Xeon Platinum 8171M CPU 2.60GHz, 1 CPU, 2 logical and 2 physical cores\n.NET SDK=6.0.200\n  [Host]     : .NET 6.0.2 (6.0.222.6406), X64 RyuJIT DEBUG\n  DefaultJob : .NET 6.0.2 (6.0.222.6406), X64 RyuJIT\n\n\n| Method |    Mean |    Error |   StdDev | Rank |      Gen 0 |      Gen 1 |     Gen 2 | Allocated |\n|------- |--------:|---------:|---------:|-----:|-----------:|-----------:|----------:|----------:|\n| Format | 2.434 s | 0.0415 s | 0.0388 s |    1 | 92000.0000 | 33000.0000 | 2000.0000 |      2 GB |</code></pre></div>\n<p><em>After</em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">BenchmarkDotNet=v0.13.1, OS=ubuntu 20.04\nIntel Xeon Platinum 8171M CPU 2.60GHz, 1 CPU, 2 logical and 2 physical cores\n.NET SDK=6.0.200\n  [Host]     : .NET 6.0.2 (6.0.222.6406), X64 RyuJIT DEBUG\n  DefaultJob : .NET 6.0.2 (6.0.222.6406), X64 RyuJIT\n\n\n| Method |     Mean |    Error |   StdDev | Rank |      Gen 0 |     Gen 1 |     Gen 2 | Allocated |\n|------- |---------:|---------:|---------:|-----:|-----------:|----------:|----------:|----------:|\n| Format | 715.2 ms | 13.48 ms | 18.46 ms |    1 | 12000.0000 | 4000.0000 | 1000.0000 |    202 MB |</code></pre></div>\n<p>In this blogpost, I’ll elaborate a bit how we did this and what you can expect from the V5 release.</p>\n<h2>F# eXchange 2021</h2>\n<p>Last October, I had the opportunity to speak at <a href=\"https://skillsmatter.com/skillscasts/17236-fantomas-v\">F# eXchange</a>.\nThere I announced that what the plan was for the next major of Fantomas and how to get there.\nA crucial part of that talk was about how improving the <code class=\"language-text\">Syntax tree</code> at <a href=\"https://github.com/dotnet/fsharp/blob/main/src/fsharp/SyntaxTree.fsi\">dotnet/fsharp</a> was the key to everything.\nIn short, a better syntax tree, leads to fewer shenanigans in the Fantomas codebase.</p>\n<blockquote>\n<p>In short, a better syntax tree, leads to fewer shenanigans in the Fantomas codebase.</p>\n</blockquote>\n<h2>Trivia</h2>\n<p>A significant part of improving the syntax tree was the introduction of <a href=\"https://github.com/dotnet/fsharp/issues/12418\">Trivia</a>.\n<code class=\"language-text\">Trivia</code> has a bit of dual meaning:</p>\n<ul>\n<li>In Fantomas, we use it as a denominator for additional information that was present in the source code, but not captured in the AST. For example code comments or newlines.</li>\n<li>In the F# compiler, we use it as a denominator for addition information about syntax, that the compiler doesn’t need to compile to binary. For example the range of the <code class=\"language-text\">let</code> keyword in a binding.</li>\n</ul>\n<p>Having <a href=\"https://github.com/dotnet/fsharp/blob/main/src/fsharp/SyntaxTree.fsi\">additional trivia information</a> in the syntax tree is of immense value to Fantomas.</p>\n<h3>Keywords</h3>\n<p>Having more information about keywords allows us to better release what the user originally wrote.\nIf we take a look at the AST for</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">MyType</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">abstract</span> One <span class=\"token punctuation\">:</span> <span class=\"token class-name\">unit <span class=\"token operator\">-></span> unit</span>\n    <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">member</span> Two<span class=\"token punctuation\">:</span> <span class=\"token class-name\">unit <span class=\"token operator\">-></span> unit</span></code></pre></div>\n<p>we get something along the lines of</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\">Types\n <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>SynTypeDefn\n     <span class=\"token punctuation\">(</span>SynComponentInfo\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>MyType<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n         PreXmlDoc <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FSharp<span class=\"token punctuation\">.</span>Compiler<span class=\"token punctuation\">.</span>Xml<span class=\"token punctuation\">.</span>XmlDocCollector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n         <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">,</span> tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      ObjectModel\n        <span class=\"token punctuation\">(</span>Unspecified<span class=\"token punctuation\">,</span>\n         <span class=\"token punctuation\">[</span>AbstractSlot\n            <span class=\"token punctuation\">(</span>SynValSig\n               <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> SynIdent <span class=\"token punctuation\">(</span>One<span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n             <span class=\"token punctuation\">{</span> IsInstance <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span>\n               IsDispatchSlot <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span>\n               IsOverrideOrExplicitImpl <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n               IsFinal <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n               MemberKind <span class=\"token operator\">=</span> Member\n               Trivia <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> MemberRange <span class=\"token operator\">=</span> None\n                          OverrideRange <span class=\"token operator\">=</span> None\n                          AbstractRange <span class=\"token operator\">=</span> Some tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span>\n                          StaticRange <span class=\"token operator\">=</span> None\n                          DefaultRange <span class=\"token operator\">=</span> None <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          AbstractSlot\n            <span class=\"token punctuation\">(</span>SynValSig\n               <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> SynIdent <span class=\"token punctuation\">(</span>Two<span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n             <span class=\"token punctuation\">{</span> IsInstance <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span>\n               IsDispatchSlot <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span>\n               IsOverrideOrExplicitImpl <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n               IsFinal <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n               MemberKind <span class=\"token operator\">=</span> Member\n               Trivia <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> MemberRange <span class=\"token operator\">=</span> Some tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">19</span><span class=\"token punctuation\">)</span>\n                          OverrideRange <span class=\"token operator\">=</span> None\n                          AbstractRange <span class=\"token operator\">=</span> Some tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span>\n                          StaticRange <span class=\"token operator\">=</span> None\n                          DefaultRange <span class=\"token operator\">=</span> None <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>We can see in the <code class=\"language-text\">Trivia</code> of <a href=\"https://fsharp.github.io/fsharp-compiler-docs/reference/fsharp-compiler-syntax-synmemberflags.html#Trivia\">SynMemberFlags</a> what exact keywords were used for <code class=\"language-text\">One</code> and <code class=\"language-text\">Two</code>.\nBecause of this new information, we can restore exactly what was written.</p>\n<h3>Identifier</h3>\n<p>Consider</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">+</span><span class=\"token punctuation\">)</span> a b <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b <span class=\"token operator\">+</span> <span class=\"token number\">1</span></code></pre></div>\n<p>The compiled function name the F# compiler will use in the typed tree is <code class=\"language-text\">op_Addition</code>. We can determine this from tracing it back to the <code class=\"language-text\">+</code> operator, however, there is no mentioning of the parentheses.\nLuckily the AST looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token function\">SynLongIdent</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span>op_Addition<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">[</span>Some <span class=\"token punctuation\">(</span><span class=\"token function\">OriginalNotationWithParen</span><span class=\"token punctuation\">(</span>tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"+\"</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Because of <a href=\"https://fsharp.github.io/fsharp-compiler-docs/reference/fsharp-compiler-syntaxtrivia-identtrivia.html#OriginalNotationWithParen\">OriginalNotationWithParen</a> we can very efficiently restore the function name as <code class=\"language-text\">(+)</code>.</p>\n<p>This is very significant because beforehand we needed to <strong>check every identifier</strong> within a file to determine <strong>if it is an operator or not</strong>.\nIdentifiers are all over the place so this really is an immense performance boost.</p>\n<h2>No Tokens, No Cry</h2>\n<p>Talking about Trivia, not everything was present in the syntax tree. Originally, we also processed the tokens of each file.\nInside these tokens were addition clues to what the user actually wrote. We needed to find these clues (<code class=\"language-text\">trivia</code>) and link them to the actual syntax tree nodes (<code class=\"language-text\">trivia nodes</code>). This was a tedious operation.</p>\n<p>Though we still have the concept of trivia, we don’t need to process the tokens anymore to detect the missing pieces.\nThe syntax tree carries enough information for us to extract the remaining trivia from source code.</p>\n<p>For example the ranges of any code comments are now part of the syntax tree:</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span> <span class=\"token number\">42</span> <span class=\"token comment\">// some comment</span></code></pre></div>\n<p>the matching tree</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\">ImplFile\n  <span class=\"token punctuation\">(</span>ParsedImplFileInput\n     <span class=\"token punctuation\">(</span><span class=\"token string\">\"tmp.fsx\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">true</span><span class=\"token punctuation\">,</span> QualifiedNameOfFile Tmp$fsx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span>SynModuleOrNamespace\n         <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>Tmp<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> AnonModule<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">[</span>Let\n             <span class=\"token punctuation\">(</span><span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">[</span>SynBinding\n                 <span class=\"token punctuation\">(</span>None<span class=\"token punctuation\">,</span> Normal<span class=\"token punctuation\">,</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                  PreXmlDoc <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FSharp<span class=\"token punctuation\">.</span>Compiler<span class=\"token punctuation\">.</span>Xml<span class=\"token punctuation\">.</span>XmlDocCollector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                  SynValData\n                    <span class=\"token punctuation\">(</span>None<span class=\"token punctuation\">,</span> SynValInfo <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> SynArgInfo <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                  Named <span class=\"token punctuation\">(</span>SynIdent <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">,</span> tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                  None<span class=\"token punctuation\">,</span> Const <span class=\"token punctuation\">(</span>Int32 <span class=\"token number\">42</span><span class=\"token punctuation\">,</span> tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                  tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Yes tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                  <span class=\"token punctuation\">{</span> LetKeyword <span class=\"token operator\">=</span> Some tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n                    EqualsRange <span class=\"token operator\">=</span> Some tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> PreXmlDocEmpty<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> None<span class=\"token punctuation\">,</span>\n          tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> ModuleKeyword <span class=\"token operator\">=</span> None\n                                 NamespaceKeyword <span class=\"token operator\">=</span> None <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> ConditionalDirectives <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        CodeComments <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>LineComment tmp<span class=\"token punctuation\">.</span>fsx <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The example above will contain the <code class=\"language-text\">range</code> of <code class=\"language-text\">// some comment</code>. This doesn’t tell us yet that it belong to <code class=\"language-text\">v</code>, but it is a step in the right direction.\nWe don’t need to process any tokens to learn about the existence of the comment. And that’s a good thing!</p>\n<h2>Fullmetal Alchemist</h2>\n<p>All these changes on the compiler side at <code class=\"language-text\">dotnet/fsharp</code> are shipped as the <a href=\"https://www.nuget.org/packages/FSharp.Compiler.Service\">FSharp.Compiler.Service</a> NuGet package.\nThe release schedule of these packages is a bit of mystery and appears to be tied to the .NET SDK releases. I started looking for a way we could have these changes faster and we are now creating our own <a href=\"https://www.nuget.org/packages/Fantomas.FCS\">Fantomas flavoured FSharp.Compiler.Service</a> package.</p>\n<p>I wrote some prose on <a href=\"https://github.com/fsprojects/fantomas/blob/master/docs/Fantomas-V.md\">the technical details</a> and I invite you to read it. But the gist is that we take the files we need from <code class=\"language-text\">dotnet/fsharp</code> at a known commit pointer and expose the parser tailored to the needs of Fantomas.\nEnd-users don’t need to worry about this, as this is all happening under the hood.</p>\n<h3>Code generation</h3>\n<p>If you are using Fantomas to generate code, that is still possible. <code class=\"language-text\">Fantomas.FCS</code> has exactly the same namespaces as the <code class=\"language-text\">FSharp.Compiler.Service</code> has, so migrating should be doable.</p>\n<h2>Fantomas Five</h2>\n<p>Besides the performance there are some <a href=\"https://github.com/fsprojects/fantomas/issues/2160\">other topics</a> planned for the next major release.</p>\n<h3>fantomas-tool -> fantomas</h3>\n<p>We renamed the .NET tool from <a href=\"https://www.nuget.org/packages/fantomas-tool/4.7.9\">fantomas-tool</a> to <a href=\"https://www.nuget.org/packages/fantomas/5.0.0-alpha-007\">fantomas</a>.\nFrom now on, you can just install it using <code class=\"language-text\">dotnet tool install fantomas --prerelease</code>.</p>\n<blockquote>\n<p>dotnet tool install fantomas —prerelease</p>\n</blockquote>\n<h3>Logo</h3>\n<p>We posted <a href=\"https://en.99designs.be/logo-design/contests/redesign-software-program-logo-make-more-compelling-1157921/poll/436a424158/vote?utm_source=voting_app&#x26;utm_medium=web&#x26;utm_campaign=voting\">a poll</a> for a logo contest.\nFor the next major release, we want to work on the Fantomas branding as well.\nA first step here was looking for a new logo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 420px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/91a90479f35e1f5510abd6abe97eb2e8/65f94/new_fantomas_logo.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAECAwQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAe/ViTYQUAD/xAAYEAEBAQEBAAAAAAAAAAAAAAABAAIgIf/aAAgBAQABBQKNDqWPHj//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAaEAEAAQUAAAAAAAAAAAAAAAABABASIDFB/9oACAEBAAY/AonSmotrj//EABwQAQACAQUAAAAAAAAAAAAAAAEAIREQIFFhcf/aAAgBAQABPyGAF5NMFZPkJeL1CzZ//9oADAMBAAIAAwAAABC8zzz/xAAWEQEBAQAAAAAAAAAAAAAAAAARASD/2gAIAQMBAT8Qqwx//8QAFhEAAwAAAAAAAAAAAAAAAAAAAREg/9oACAECAQE/EAo//8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAMRAhQSD/2gAIAQEAAT8QjZiUVOsXw5HDgAaHjQhIKIYo+P/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"New Fantomas logo\"\n        title=\"New Fantomas logo\"\n        src=\"/static/91a90479f35e1f5510abd6abe97eb2e8/65f94/new_fantomas_logo.jpg\"\n        srcset=\"/static/91a90479f35e1f5510abd6abe97eb2e8/a80bd/new_fantomas_logo.jpg 148w,\n/static/91a90479f35e1f5510abd6abe97eb2e8/1c91a/new_fantomas_logo.jpg 295w,\n/static/91a90479f35e1f5510abd6abe97eb2e8/65f94/new_fantomas_logo.jpg 420w\"\n        sizes=\"(max-width: 420px) 100vw, 420px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Get Back</h2>\n<p>Having a faster formatter won’t necessarily bring you in if you are not using Fantomas today.\nEven though Fantomas follows the <a href=\"https://docs.microsoft.com/en-us/dotnet/fsharp/style-guide/formatting\">F# style guide</a>, some people still don’t use it.</p>\n<p>At the end of last year, I had a change of heart about <a href=\"https://github.com/fsprojects/fantomas/issues/1408#issuecomment-1000197855\">Stroustrup bracket style</a>.\nThe re-opening of this issue was well received by the community:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e75772016bf426a45720826194c01564/bad1b/Stroustrup-bracket-style-feedback.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABB0lEQVQoz42R2W7EIAxF+/+/OWGy2WCHzRCWlqnaidRO1SOEbMF5uPabIZ7ndduhtd57b61fi/ak/zjtzXt3HFxKrbU87lrLqEodTX/NkHPylpGIicgYMkRErLUxxMScUhKR8zxfywTakNYaAAEHgBpR7wDMh0jMOf8u7wD3+yM0Yinl8nb9dw3fnplFxDlvrfM+xCiDlPqfPGVn7TRNy7Iqdb/dlJrUpNS2w7pt87xa60QkxhhijFFC8N8RhhxCQESjadOodl4gLOhncAu4BT1Q3HQwZEMIKWcRyV/D+1yVN8Ywj2lvfOxHxaNom2NMtfXaemm9vVqVD/7Mvp7hzDmn3P/Nh/wObaJGhgw7mEoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Community feedback\"\n        title=\"Community feedback\"\n        src=\"/static/e75772016bf426a45720826194c01564/fcda8/Stroustrup-bracket-style-feedback.png\"\n        srcset=\"/static/e75772016bf426a45720826194c01564/12f09/Stroustrup-bracket-style-feedback.png 148w,\n/static/e75772016bf426a45720826194c01564/e4a3f/Stroustrup-bracket-style-feedback.png 295w,\n/static/e75772016bf426a45720826194c01564/fcda8/Stroustrup-bracket-style-feedback.png 590w,\n/static/e75772016bf426a45720826194c01564/bad1b/Stroustrup-bracket-style-feedback.png 841w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>I prefer an opinionated view on the style of things, yet at the same time I want to be open to feedback of the community.</p>\n<h3>Ragnarok</h3>\n<p>Before re-opening that issue, I made an initial proof of concept and got something working.</p>\n<p>Later <a href=\"https://github.com/josh-degraw\">Josh DeGraw</a> <a href=\"https://github.com/fsprojects/fantomas/pull/2161\">ported the code</a> and you can now activate it by adding:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[*.fs]\nfsharp_multiline_block_brackets_on_same_column=true\nfsharp_experimental_stroustrup_style=true</code></pre></div>\n<p>Thank you Josh!</p>\n<blockquote>\n<p>It is a small step for Fantomas, but a giant leap for the F# community</p>\n</blockquote>\n<p>It has been around since <a href=\"https://www.nuget.org/packages/fantomas-tool/5.0.0-alpha-001\">5.0.0-alpha-001</a> (March 19th 2022), yet I haven’t really received any feedback on this.\nThis is a known problem when developing any software, and one I’ve seen in Fantomas: people will only try new features once they are considered stable.</p>\n<p><strong>Please try this out and participate on GitHub!!</strong></p>\n<p>There are a lot of open technical and philosophical questions regarding this topic, so if this matters to you, please help to push this forward!</p>\n<h3>Elmish no more</h3>\n<h4>Beware the vanity alignment PD</h4>\n<p>The Fantomas default settings do not respect the F# style guides when you have a function application that take a list (or two lists) as its last argument.\nIn the common tongue, this often reflects to an Elmish DSL.</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span>\n    Input<span class=\"token punctuation\">.</span>input <span class=\"token punctuation\">[</span> Input<span class=\"token punctuation\">.</span>Custom <span class=\"token punctuation\">[</span> Placeholder placeholder\n                                 <span class=\"token function\">OnChange</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> ev <span class=\"token operator\">-></span> ev<span class=\"token punctuation\">.</span>Value <span class=\"token operator\">|></span> onChange<span class=\"token punctuation\">)</span>\n                                 DefaultValue value\n                                 Key key <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p>Though this looks okay-ish when you are coding something with Fable, it doesn’t make sense for other things like:</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> sorted <span class=\"token operator\">=</span>\n    List<span class=\"token punctuation\">.</span>sortDescending <span class=\"token punctuation\">[</span> <span class=\"token string\">\"Alpha\"</span>\n                          <span class=\"token string\">\"Beta\"</span>\n                          <span class=\"token string\">\"Gamma\"</span>\n                          <span class=\"token string\">\"Delta\"</span>\n                          <span class=\"token string\">\"Epsilon\"</span> <span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p>And if you change the <code class=\"language-text\">List.sort</code> to <code class=\"language-text\">List.sortDescending</code>, all the items of the list will jump around.\nThis is known as <em>the dreaded vanity alignment problem</em>, where the name of the identifier influences the positioning of the remainder of the expression.</p>\n<p>The style guide would suggest to format this as:</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span>\n    Input<span class=\"token punctuation\">.</span>input\n        <span class=\"token punctuation\">[</span> Input<span class=\"token punctuation\">.</span>Custom\n              <span class=\"token punctuation\">[</span> Placeholder placeholder\n                <span class=\"token function\">OnChange</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> ev <span class=\"token operator\">-></span> ev<span class=\"token punctuation\">.</span>Value <span class=\"token operator\">|></span> onChange<span class=\"token punctuation\">)</span>\n                DefaultValue value\n                Key key <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">let</span> sorted <span class=\"token operator\">=</span>\n    List<span class=\"token punctuation\">.</span>sortDescending\n        <span class=\"token punctuation\">[</span> <span class=\"token string\">\"Alpha\"</span>\n          <span class=\"token string\">\"Beta\"</span>\n          <span class=\"token string\">\"Gamma\"</span>\n          <span class=\"token string\">\"Delta\"</span>\n          <span class=\"token string\">\"Epsilon\"</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>In the 4.x series, you were able to do this using the setting <code class=\"language-text\">fsharp_disable_elmish_syntax=true</code>, but it was unfortunate this wasn’t the default behavior.\nWith a major release, we can address these things.</p>\n<h4>Expanding on lists at the end</h4>\n<p>The Elmish-like shapes that did not follow the style guide were fairly restricted.\nIf a small detail was altered, the shape would not match anymore and so there would have been a difference between:</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token comment\">// matches the AST shape of a function application with two lists</span>\ndiv <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// some comment</span>\n    p <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span> str <span class=\"token string\">\"x\"</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// does not match the AST shape of a function application with two lists</span>\n<span class=\"token comment\">// because of that extra string argument</span>\ndiv\n    <span class=\"token string\">\"some string\"</span>\n    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">// some comment</span>\n      p <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span> str <span class=\"token string\">\"y\"</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>This had its limitations and we want to <a href=\"https://github.com/fsprojects/fantomas/issues/2180\">revisit</a> this as well.\nWe want to get rid of all the Elmish specific settings (<code class=\"language-text\">fsharp_max_elmish_width</code>, <code class=\"language-text\">fsharp_single_argument_web_mode</code>, <code class=\"language-text\">fsharp_disable_elmish_syntax</code>) and instead consider this as a part of the Stroustrup setting.</p>\n<p>Maybe something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token comment\">// list at the end</span>\ndiv <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// some comment</span>\n    p <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span> str <span class=\"token string\">\"x\"</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// also list at the end</span>\ndiv <span class=\"token string\">\"some string\"</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// some comment</span>\n    p <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span> str <span class=\"token string\">\"y\"</span> <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p><a href=\"https://github.com/TheAngryByrd\">Jimmy Byrd</a> started working on this in <a href=\"https://github.com/fsprojects/fantomas/pull/2200\">PR 2200</a>.<br>\nThank you Jimmy!</p>\n<h2>Closing thoughts</h2>\n<p>The changes are significant in version five and I believe that the best is yet to come.\nPlease try this one out, report issues using <a href=\"https://fsprojects.github.io/fantomas-tools/#/fantomas/preview\">our online tool</a> and let us know on <a href=\"https://discord.gg/D5QXvQrBVa\">Discord</a> how thing are going.</p>\n<p>Cheers,</p>\n<p>Florian</p>\n<p><small>Photo by <a href=\"https://unsplash.com/@david_bxl?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">David Bruyndonckx</a> on <a href=\"https://unsplash.com/photos/4XLdfSieqP0?utm_source=unsplash&utm_medium=referral&utm_content=creditShareLink\">Unsplash</a></small></p>","frontmatter":{"title":"World domination, part one","date":"2022-05-24","path":"2022/05/24/word-domination-part-one/","tags":["open-source","fsharp","fantomas","tooling"],"cover":{"publicURL":"/static/3a35a58fb9d042c46074b205cd0756dd/blog.nojaf.com-world-domination-part-one.jpg"}}}},"pageContext":{"slug":"/world-domination-part-one/","previous":{"fields":{"slug":"/a-word-on-triple-slash-comments/"},"frontmatter":{"title":"A word on triple-slash comments","path":"2022/03/05/a-word-on-triple-slash-comments/","tags":["open-source","fsharp","fantomas","tooling"]}},"next":null}},
    "staticQueryHashes": ["3128451518","677231581"]}