{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022/12/22/the-oak-sleeps-in-the-acorn/","result":{"data":{"site":{"siteMetadata":{"title":"blog.nojaf.com","author":"Florian Verdonck"}},"markdownRemark":{"id":"f27606f7-fe24-5d51-bcf8-a0b3e3181563","excerpt":"Introduction We launched Fantomas v5 in September, and it was the first version to ship with a custom F# parser and an improved syntax tree.\nMany view it as a…","html":"<h2>Introduction</h2>\n<p>We launched Fantomas v5 in September, and it was the first version to ship with a custom F# parser and an improved syntax tree.\nMany view it as a big technical achievement – I know its launch was a point of personal pride.</p>\n<h2>Release party</h2>\n<p>Because version 5 was a big deal, I decided to organize a grand release party where we talked about how <a href=\"https://github.com/fsprojects/fantomas/releases/tag/v5.0.0\">v5</a> came to be,\nwhat exactly changes for end-users and I wrapped it up with a well-deserved glass of champagne. The project is in a good state. We have a brand new <a href=\"https://fsprojects.github.io/fantomas/docs/index.html\">documentation website</a>, I onboarded a new co-maintainer <a href=\"https://github.com/dawedawe\">David</a>, and overall the codebase has never been better.<br>\nContributors who sent me their home address, received a tee-shirt in the mail too.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bad5f80b94bdcbfb038ba89afc4eec42/59de2/fantomas-release-party.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAV3My3JsgX//xAAcEAABAwUAAAAAAAAAAAAAAAACAAEzAwQREzL/2gAIAQEAAQUCpNkil0krfspV/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8BR//EABcRAAMBAAAAAAAAAAAAAAAAAAABETH/2gAIAQIBAT8BWlZ//8QAGxAAAgEFAAAAAAAAAAAAAAAAAAEQESEjMYH/2gAIAQEABj8Cx3Y1Q0zk/wD/xAAcEAEAAgIDAQAAAAAAAAAAAAABADERQSFhsfD/2gAIAQEAAT8hwBkJXUZQuuC9E+gl8epGf//aAAwDAQACAAMAAAAQjz//xAAWEQEBAQAAAAAAAAAAAAAAAAABADH/2gAIAQMBAT8QckN//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAhMf/aAAgBAgEBPxDSIDjf/8QAHhABAQACAAcAAAAAAAAAAAAAAREAMSFBUaGxwfD/2gAIAQEAAT8QMpvaAUXYc8sDlQUeGjqPXC6tVrV+s7p5M3fWs3z/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fantomas release party\"\n        title=\"Fantomas release party\"\n        src=\"/static/bad5f80b94bdcbfb038ba89afc4eec42/1c72d/fantomas-release-party.jpg\"\n        srcset=\"/static/bad5f80b94bdcbfb038ba89afc4eec42/a80bd/fantomas-release-party.jpg 148w,\n/static/bad5f80b94bdcbfb038ba89afc4eec42/1c91a/fantomas-release-party.jpg 295w,\n/static/bad5f80b94bdcbfb038ba89afc4eec42/1c72d/fantomas-release-party.jpg 590w,\n/static/bad5f80b94bdcbfb038ba89afc4eec42/a8a14/fantomas-release-party.jpg 885w,\n/static/bad5f80b94bdcbfb038ba89afc4eec42/fbd2c/fantomas-release-party.jpg 1180w,\n/static/bad5f80b94bdcbfb038ba89afc4eec42/59de2/fantomas-release-party.jpg 2247w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Work remains</h2>\n<p>Fantomas will always be a very malleable project. This project demands a lot of care and maintenance over time, and exceptional endeavours have been undertaken to lessen the burden.\nBut there is always something left to improve. Be it the syntax tree, be it the style guide, or the editor integration there will always be something left to update, make better, or to maintain.</p>\n<p>Nowadays, I will personally only address topics of interest over the weekend as a hobby. This removes any weight from my shoulders that is implied by being a maintainer.</p>\n<h2>Growing the community</h2>\n<p>Ever since David  joined me as co-maintainer of Fantomas, I’m quite intrigued on how I can get more people involved in the project.\nA response to that was adding more and more documentation. I recently wrote <a href=\"https://fsprojects.github.io/fantomas/docs/contributors/The%20Missing%20Comment.html\">a guide</a> with steps that people can take to solve a missing-code comment problem.\nThis is frustrating problem- space in Fantomas. Yet, once you get a sense of how things work, you can easily see solutions. I must admit, these seven steps in the guide do expose the fact that the overall flow is a bit complicated.</p>\n<p>In a nutshell, when we process F# code, we only know that comments appeared in the file, as in “somewhere” in the file – and that is it.\nVia a caching system, we try and figure out what the best location is to restore the comment and hope that somewhat it plays out.\nWe need that caching system because we can’t extend the F# syntax tree model which the parser creates.</p>\n<h2>Project Dallas</h2>\n<p>I’ve been working on a custom syntax tree that better suits the needs of Fantomas for some time.\nWe transform the existing syntax tree into a custom syntax tree that has consists of out of Nodes. The <code class=\"language-text\">Node</code> interface allows us to retrieve child nodes and can store and retrieve trivia items, (like code comments).\nThis allows us to insert the code comments directly into the tree and removes the need for a cache.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 475px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b97f28d3aa9c624a488891b111bdcaf1/466da/Node.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.54054054054053%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACF0lEQVR42pWU7W7bMAxF+/7vuTROLFnfIiXZZ7CWFOtQLK0AAvafq3PFS76VUghuJbo7ya24zbLvO+c5joOfnrdaFR8StWT2MabYKfSdel7698VvqXQuphPdSvLmg+475ysHb8exT5HNF0JStO9Ir5SWSRqprdBHpzelqdCkMnqb9SXhse/0sbNY5bYpWxRsvs+6xSsmLdQmtJrJwRK2Gzm6WV8KnnRj7FhfMK5gfcQGQ5JI1kQQP0nbaEgtjDFeWH4Q3p1gQiPLwFeLLxZXtwftSm2VFAO99y8E/7F8Et5swXidgkkDvm5sxRIlMHpHS6IkT00eKZGm9f9vaL1gfcXHgs8bSQJJ07R92uwqU6jmiNY8G/SiKcLVCKtLLP4dk+6YvLKmBVsMIpXg3Tdi87DsQiVmpY0DGfURnYIMmd+9/2nKy2A/Cd+NcLUNF5Ul/sKkFckZuy4c+/GS7HNs9h0fCikrfRwzzNJlvp2q/Ggc/yLUSbhFxdYz1JfZ5TPA50iW5CjRvV4OT0IXCjHLJOw6UBmMvs/cqepHndRnjJ7jd1JNjd4/E16NsmwNnwb+VjHvlbgptQjWWq7XK78ul9mYmgNhuxPsgrYxN9WZ0Sn4JLQ+E5LQ+kGTgZQ/hCeViHDuTdXG+FgU9UHI/N8fI/kgPLi5PuskDKuw3SolNlKKrMZwuVxYVzOFctjwZiGFDe2Qgv0I+m+FxIErQRVTGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node interface\"\n        title=\"Node interface\"\n        src=\"/static/b97f28d3aa9c624a488891b111bdcaf1/466da/Node.png\"\n        srcset=\"/static/b97f28d3aa9c624a488891b111bdcaf1/12f09/Node.png 148w,\n/static/b97f28d3aa9c624a488891b111bdcaf1/e4a3f/Node.png 295w,\n/static/b97f28d3aa9c624a488891b111bdcaf1/466da/Node.png 475w\"\n        sizes=\"(max-width: 475px) 100vw, 475px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Another benefit of our own tree is that we can customize it for our needs. The untyped tree from the compiler works for the F# compiler but stores the information sometimes a bit oddly for our use-case.</p>\n<p>Some subtle differences:</p>\n<ul>\n<li>Our tree doesn’t differentiate between implementation and signature files.</li>\n<li>We can group certain nodes in a different way. For example, recursive types are considered as top-level.</li>\n<li>We can skip combinations of nodes that the parser would never be able to create.</li>\n<li>We can simplify a lot of nodes by reducing them to only expose the core information.</li>\n<li>We can use more accurate ranges by combining positions instead of relying on the approximate information of the compiler.</li>\n</ul>\n<p>Refactoring the codebase to use our custom tree was also quite a lot of work. I had to port all our code into a new model and shuffle a lot of things around.\nThe result is that the flow is a lot less complicated than before. I am optimistic that this work will lead to more contributions from the community in the future.</p>\n<h2>Give it a spin</h2>\n<p>We currently have around 2380 unit tests for Fantomas, which may sound like a lot, but still may not fully cover your codebase. The F# language is vast and ever growing.\nSo, I do ask you to give our new implementation a spin on your existing code. Make sure you are on the latest stable release before you compare it the <code class=\"language-text\">v5.2</code> alphas.\nPlease report any issues you encounter so that we can continue to improve.</p>\n<p>Happy formatting,</p>\n<p>Florian</p>","frontmatter":{"title":"The oak sleeps in the acorn","date":"2022-12-22","path":"2022/12/22/the-oak-sleeps-in-the-acorn/","tags":["open-source","fsharp","fantomas","tooling"],"cover":{"publicURL":"/static/e158ba6f20f953b1bd748aa5a28f76db/blog.nojaf.com-the-oak-sleeps-in-the-acorn.jpg"}}}},"pageContext":{"slug":"/the-oak-sleeps-in-the-acorn/","previous":{"fields":{"slug":"/say-hello-to-fantomas-five/"},"frontmatter":{"title":"Say Hello to Fantomas 5","path":"2022/08/25/say-hello-to-fantomas-five/","tags":["open-source","fsharp","fantomas","tooling"]}},"next":{"fields":{"slug":"/my-fsharp-compiler-scripts/"},"frontmatter":{"title":"My F# compiler scripts","path":"2023/02/02/my-fsharp-compiler-scripts/","tags":["open-source","fsharp","tooling"]}}}},"staticQueryHashes":["3128451518","677231581"],"slicesMap":{}}